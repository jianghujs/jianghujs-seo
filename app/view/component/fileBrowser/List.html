<template id="fileBrowser-list">
    <v-card flat tile min-height="380" class="d-flex flex-column" style="height: calc(100vh - 100px); overflow: scroll;">
        <confirm ref="confirm"></confirm>
        <v-toolbar v-if="path && isDir" dense flat class="shrink">
            <v-text-field solo flat hide-details label="Filter" v-model="filter" prepend-inner-icon="mdi-filter-outline"
                class="ml-n3"></v-text-field>
            <v-btn icon v-if="false">
                <v-icon>mdi-eye-settings-outline</v-icon>
            </v-btn>
            <v-btn icon @click="load">
                <v-icon>mdi-refresh</v-icon>
            </v-btn>
        </v-toolbar>
        <v-card-text v-if="!path" class="grow d-flex justify-center align-center grey--text">请选择一个文件夹或文件</v-card-text>
        <v-card-text v-else-if="isFile" class="grow d-flex justify-center align-center">
            <div style="position: absolute; text-align: center;" class="flex flex-column justify-center align-center">
                <v-img v-if="fileType === 'image'" min-width="30" max-width="500" min-height="30" max-height="500"
                    :src="`/<$ ctx.app.config.appId $>/upload/materialRepo/${path}?v=${new Date().getTime()}`" :key="path" lazy-src=""
                    class="grey lighten-2 mb-5" style="margin: auto; cursor: pointer;"
                    @click="openFile(`/<$ ctx.app.config.appId $>/upload/materialRepo/${path}?v=${new Date().getTime()}`)">
                </v-img>
                <video v-if="fileType === 'video'" min-width="30" max-width="500" min-height="30" max-height="500"
                    :src="`/<$ ctx.app.config.appId $>/upload/materialRepo/${path}?v=${new Date().getTime()}`" :key="path" lazy-src=""
                    class="grey lighten-2 mb-5" style="display: block; margin: auto;" controls>
                    <source :src="`/<$ ctx.app.config.appId $>/upload/materialRepo/${path}?v=${new Date().getTime()}`" type="video/mp4">
                </video>
                <audio v-if="fileType === 'audio'" min-width="30" max-width="500" min-height="30" max-height="500"
                    :src="`/<$ ctx.app.config.appId $>/upload/materialRepo/${path}?v=${new Date().getTime()}`" :key="path" lazy-src=""
                    class="grey lighten-2 mb-5" style="display: block; margin: auto;" controls>
                    <source :src="`/<$ ctx.app.config.appId $>/upload/materialRepo/${path}?v=${new Date().getTime()}`" type="audio/mpeg">
                </audio>
                文件: {{ path }}
            </div>
        </v-card-text>
        <v-card-text v-else-if="dirs.length || files.length" class="grow">
            <v-list subheader v-if="dirs.length">
                <v-subheader>Folders</v-subheader>
                <v-list-item v-for="item in dirs" :key="item.basename" @click="changePath(item.path)" class="pl-0">
                    <v-list-item-avatar class="ma-0">
                        <v-icon>mdi-folder-outline</v-icon>
                    </v-list-item-avatar>
                    <v-list-item-content class="py-2">
                        <v-list-item-title v-text="item.basename"></v-list-item-title>
                    </v-list-item-content>
                    <v-list-item-action>
                        <div class="flex">
                            <!-- <v-btn
                                v-if="operationOption.copy === true && ['/_recycle/', '/image/', '/audio/', '/video/', '/attachment/'].indexOf(item.path) === -1"
                                icon @click.stop="cutItem(item)">
                                <v-icon color="grey lighten-1" style="font-size: 20px;">mdi-content-cut</v-icon>
                            </v-btn>
                            <v-btn
                                v-if="operationOption.copy === true && ['/_recycle/', '/image/', '/audio/', '/video/', '/attachment/'].indexOf(item.path) === -1"
                                icon @click.stop="copyItem(item)">
                                <v-icon color="grey lighten-1" style="font-size: 20px;">mdi-content-copy</v-icon>
                            </v-btn> -->
                            <template v-if="operationOption.delete === true && !item.path.startsWith('/_recycle/')">
                                <v-btn
                                    v-if="['/_recycle/', '/image/', '/audio/', '/video/', '/attachment/'].indexOf(item.path) === -1"
                                    icon @click.stop="deleteItem(item)">
                                    <v-icon color="grey lighten-1">mdi-delete-outline</v-icon>
                                </v-btn>
                            </template>
                            <v-btn icon v-if="false">
                                <v-icon color="grey lighten-1">mdi-information</v-icon>
                            </v-btn>
                        </div>
                    </v-list-item-action>
                </v-list-item>
            </v-list>
            <v-divider v-if="dirs.length && files.length"></v-divider>
            <v-list subheader v-if="files.length">
                <v-subheader>Files</v-subheader>
                <v-list-item v-for="item in files.slice((page-1)*pageSize, page*pageSize)" :key="item.basename" @click="changePath(item.path)" class="pl-0">
                    <v-list-item-avatar class="ma-0" tile size="55">
                        <v-img 
                            v-if="checkIsImg(item.basename)"
                            :src="`/<$ ctx.app.config.appId $>/upload/materialRepo/${path}/${item.basename}?v=${new Date().getTime()}`"></v-img>
                        <v-icon v-else >{{ icons[item.extension.toLowerCase()] || icons['other'] }}</v-icon>
                    </v-list-item-avatar>

                    <v-list-item-content class="py-2">
                        <v-list-item-title v-text="item.basename"></v-list-item-title>
                        <v-list-item-subtitle>{{ formatBytes(item.size) }}</v-list-item-subtitle>
                    </v-list-item-content>

                    <!-- v-if="item.path.indexOf('_recycle') === -1" -->
                    <v-list-item-action>
                        <div class="flex">
                            <v-menu v-if="operationOption.renameFile === true && !item.path.startsWith('/_recycle/')" v-model="item.newFolderPopper" :close-on-content-click="false" :nudge-width="200" offset-y>
                                <template v-slot:activator="{ on }">
                                    <span>
                                        <v-btn v-if="path" icon v-on="on" @click="item.newFilename=item.basename;">
                                            <v-icon color="grey lighten-1" style="font-size: 20px;">mdi-rename-box</v-icon>
                                        </v-btn>
                                    </span>
                                </template>             
                                <v-card>
                                    <v-card-text>
                                        <v-text-field label="文件名" v-model="item.newFilename" hide-details></v-text-field>
                                    </v-card-text>
                                    <v-card-actions>
                                        <div class="flex-grow-1"></div>
                                        <v-btn @click="item.newFolderPopper = false" depressed>取消</v-btn>
                                        <v-btn color="success" :disabled="!item.newFilename" depressed @click="renameFile(item)">重命名</v-btn>
                                    </v-card-actions>
                                </v-card>
                            </v-menu>


                            <v-btn v-if="operationOption.copy === true" icon @click.stop="cutItem(item)">
                                <v-icon color="grey lighten-1" style="font-size: 20px;">mdi-content-cut</v-icon>
                            </v-btn>
                            <v-btn v-if="operationOption.copy === true && !item.path.startsWith('/_recycle/')" icon @click.stop="copyItem(item)">
                                <v-icon color="grey lighten-1" style="font-size: 20px;">mdi-content-copy</v-icon>
                            </v-btn>
                            <v-btn v-if="operationOption.delete === true && !item.path.startsWith('/_recycle/')" icon @click.stop="deleteItem(item)">
                                <v-icon color="grey lighten-1">mdi-delete-outline</v-icon>
                            </v-btn>
                            <v-btn v-if="false" icon>
                                <v-icon color="grey lighten-1">mdi-information</v-icon>
                            </v-btn>
                        </div>
                    </v-list-item-action>
                </v-list-item>
            </v-list>
        </v-card-text>
        <v-card-text v-else-if="filter" class="grow d-flex justify-center align-center grey--text py-5">未找到文件或文件夹
        </v-card-text>
        <v-card-text v-else class="grow d-flex justify-center align-center grey--text py-5">文件夹是空的</v-card-text>
        <v-divider v-if="path"></v-divider>
        <v-toolbar v-if="false && path && isFile" dense flat class="shrink">
            <v-btn icon>
                <v-icon>mdi-download</v-icon>
            </v-btn>
        </v-toolbar>
        <div class="text-center" v-if="totalPage > 0">
            <v-pagination v-model="page" :length="totalPage" :total-visible="7"></v-pagination>
        </div>
    </v-card>
</template>

<script>
    Vue.component("list", {
        vuetify: new Vuetify(),
        name: 'list',
        template: '#fileBrowser-list',
        props: {
            icons: Object,
            storage: String,
            path: String,
            endpoints: Object,
            axios: Function,
            refreshPending: Boolean,
            operationOption: Object,
        },
        data() {
            return {
                items: [],
                filter: "",
                page: 1,
                pageSize: 20,
            };
        },
        watch: {

        },
        computed: {
            dirs() {
                return this.items.filter(
                    item =>
                        item.type === "dir" && item.basename.includes(this.filter)
                );
            },
            files() {
                return this.items.filter(
                    item =>
                        item.type === "file" && item.basename.includes(this.filter)
                );
            },
            totalCount() {
                return this.files.length;
            },
            totalPage() {
                return Math.ceil(this.files.length / this.pageSize) ;
            },
            isDir() {
                return this.path[this.path.length - 1] === "/";
            },
            isFile() {
                return !this.isDir;
            },
            fileType() {
                const ext = this.path.substring(this.path.lastIndexOf('.') + 1);
                if (ext) {
                    if (['jpg', 'jpeg', 'png', 'gif', 'ico', 'svg'].includes(ext.toLowerCase())) {
                        return 'image';
                    }
                    if (['mp4'].includes(ext.toLowerCase())) {
                        return 'video';
                    }
                    if (['mp3'].includes(ext.toLowerCase())) {
                        return 'audio';
                    }
                }
                return '';
            }
        },
        async mounted() {
            const that = this;
            setTimeout(() => {
                that.load();
            }, 500)
        },
        methods: {
            checkIsImg(filename) {
                return /\.(jpg|jpeg|png|GIF|JPG|PNG)$/.test(filename);
            },
            changePath(path) {
                this.$emit("path-changed", path);
            },
            async load() {
                this.$emit("loading", true);
                if (this.isDir) {
                    const path = this.path;
                    const rows = (await window.jianghuAxios({
                        data: {
                            appData: {
                                pageId: 'materialManagement',
                                actionId: 'list',
                                actionData: { path },
                            }
                        }
                    })).data.appData.resultData.rows;
                    this.items = rows;
                } else {
                    // TODO: load file
                }
                this.$emit("loading", false);
            },
            async deleteItem(item) {
                let confirmed = await this.$refs.confirm.open(
                    "Delete",
                    `Are you sure<br>you want to delete this ${item.type === "dir" ? "folder" : "file"
                    }?<br><em>${item.basename}</em>`
                );

                if (confirmed) {
                    this.$emit("loading", true);
                    await window.jianghuAxios({
                        data: {
                            appData: {
                                pageId: 'materialManagement',
                                actionId: 'delete',
                                actionData: { path: item.path },
                            }
                        }
                    });
                    this.$emit("file-deleted");
                    this.$emit("loading", false);
                }
            },
            async cutItem(item) {
                this.$emit("cut-item", item.path);
            },
            async copyItem(item) {
                this.$emit("copy-item", item.path);
            },
            formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 bytes';

                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

                const i = Math.floor(Math.log(bytes) / Math.log(k));

                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            },
            openFile(path) {
                window.open(path)
            },
            async renameFile(item) {
                const { path, newFilename } = item;
                if (!newFilename) {
                    window.vtoast.fail('请输入文件名');
                    return;
                }
                window.vtoast.loading("文件重命名");
                await window.jianghuAxios({
                    data: {
                        appData: {
                            pageId: 'materialManagement',
                            actionId: 'renameFile',
                            actionData: {
                                path,
                                newFilename
                            },
                        }
                    }
                });
                item.newFolderPopper = false;
                this.load();
                const isDir = item.path[item.path.length - 1] === "/";
                const pathDir = isDir ? item.path : item.path.substring(0, item.path.lastIndexOf('/')+1);
                this.$emit("read-folder-by-path", pathDir);
                window.vtoast.success('文件重命名成功');
            },
        },
        watch: {
            async path() {
                this.items = [];
                await this.load();
            },
            async refreshPending() {
                if (this.refreshPending) {
                    await this.load();
                    this.$emit("refreshed");
                }
            }
        },
    });
</script>

<style scoped>
    .v-card {
        height: 100%;
    }
</style>