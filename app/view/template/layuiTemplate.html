{% set appId = ctx.app.config.appId %}
{% set userId = userInfo.userId %}
{% set username = userInfo.username %}
{% set adminUrl = ctx.app.config.adminUrl %}
{% set static = "/" + appId + "/public" %}
{% set pageUrl = "/" + appId + "/page" %}
<!DOCTYPE html>
<html lang="zh-cn" style="font-size: 15px;">

<head>
  <meta charset="UTF-8">
  <meta name=renderer content=webkit>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge，chrome=1">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="Cache-Control" content="max-age=7200" />
  <!-- <meta name="referrer" content="no-referrer"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="{% block keyword %}{% endblock %}<$ site_keywords $>" />
  <meta name="description" content="{% block description %}{% endblock %}" />
  <!-- OGP分享协议开始 -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="{% block ogp_title %}{% endblock %}">
  <meta property="og:description" content="{% block ogp_desc %}{% endblock %}">
  <meta property="og:pageUrl" content="<$ request.scheme $>://<$ request.META.HTTP_HOST $><$ request.path_info $>">

  <script async defer data-website-id="6d41fa09-0bd3-4146-9367-aba746868472" src="https://umami.openjianghu.org/jh_stat.js"></script>

  <script type="text/javascript">
    window.appInfo = {
      appId: '<$ ctx.app.config.appId $>',
      upload: '/<$ ctx.app.config.appId $>/upload',
      public: '/<$ ctx.app.config.appId $>/public',
      userAgent: navigator.userAgent || '',
    }
    if (window.appInfo.userAgent.length > 127) {
      window.appInfo.userAgent = window.appInfo.userAgent.substring(0, 126);
    }
  </script>

  <!-- OGP分享协议结束 -->
  <title>{% block title %}{% endblock %} - <$ ctx.app.config.appTitle $></title>
  <link href="<$ static $>/layui/css/layui.css" rel="stylesheet">
  <link rel="stylesheet" href="<$ static $>/jianghu/jianghu-md.css" />
  <link href="<$ static $>/jianghu/jianghu-doc.css" rel="stylesheet">
  <link href="<$ static $>/jianghu/jianghu-doc-docs.css" rel="stylesheet">
<!--  <link href="<$ static $>/iconFont/iconfont.css" rel="stylesheet">-->
  <script src="<$ static $>/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
  <script src="<$ static $>/layui/layui.js"></script>
  <script src="<$ static $>/js/lib/lodash.min.js"></script>
  <script src="<$ static $>/js/lib/axios.min.js"></script>
  <script type="text/javascript">
    window.vtoast = {
      success: ({message}) => {
        layer.msg(message, {icon: 1});
      },
      fail: ({message}) => {
        layer.msg(message, {icon: 2});
      },
      loading: ({message}) => {
        layer.msg(message, {icon: 0});
      }
    };
  </script>
  <style>
      .layui-layer-title {
          height: 60px;
          text-align: center;
          padding: 0 20px;
          font-size: 16px;
      }
      .layui-layer-setwin {
          top: 22px;
      }
  </style>
</head>

<body class="big-page">

<div class="layui-header jianghu-header <$ 'home-header' if homeActive == 'home' else '' $>">
  <div class="layui-fluid header-body">
    {% if homeActive === 'article' %}
    <i class="layui-icon header-menu-icon header-menu-icon-article layui-icon-read " style="width: 30px" onclick="showArticle()"></i>
    {% endif %}
    <a class="logo" href="/">
      <img src="<$ static $>/logo.png" alt="layui">
    </a>
    <i class="layui-icon header-menu-icon header-menu-icon-category layui-icon-shrink-right " style="" onclick="showCategoryMenu()"></i>
    <i class="layui-icon header-menu-icon header-menu-icon-user layui-icon-username "  id="userIcon" style="" ></i>
    <div class="layui-hide-xs site-notice"></div>
    <div>
      <ul class="layui-nav layui-hide-xs menu-list-box" id="LAY_NAV_TOP" style="position: unset;">
        <li class="layui-nav-item <$ 'layui-this' if homeActive == 'home' else '' $>">
          <a href="/">首&nbsp;&nbsp;页</a>
        </li>
        {% for category in categoryList %}
        <li class="layui-nav-item <$ category.active $>">
          <a href="/<$ ctx.app.config.appId $>/page/article/<$ category.articleList[0].articleId $>/"><$ category.categoryName $></a>
        </li>
        {% endfor %}
        <li class="layui-nav-item user-nav-box" style="min-width: 100px">
          {% if username %}
          <a href="javascript:void(0);">
            <i class="layui-icon layui-icon-friends"></i>
            <span class="layui-hide-xs"> <$ username $> </span>
            <i class="layui-icon layui-icon-down layui-nav-more"></i></a>
          <dl class="layui-nav-child layui-anim layui-anim-upbit">

            <dd>
              <a href="<$ adminUrl $>" title="进入站点后台管理" target="_blank">
                <i class="layui-icon layui-icon-console layui-hide-md"></i>
                <span class="layui-hide-xs">进入后台</span>
              </a>
            </dd>
            <dd>
              <a href="javascript:void(0);" onclick="changePwd()" title="修改登录密码">
                <i class="layui-icon layui-icon-password layui-hide-md"></i>
                <span class="layui-hide-xs">修改密码</span>
              </a>
            </dd>
            <dd>
              <a href="javascript:void(0);" onclick="logout()" title="退出登录">
                <i class="layui-icon layui-icon-logout layui-hide-md"></i>
                <span class="layui-hide-xs">退出登录</span>
              </a>
            </dd>
          </dl>
          {% else %}
          <a href="javascript:void(0);">
            <i class="layui-icon layui-icon-username"></i> 游客
            <i class="layui-icon layui-icon-down layui-nav-more"></i></a>
          <dl class="layui-nav-child layui-anim layui-anim-upbit">
            <dd>
              <a href="<$ pageUrl $>/login">
                <i class="iconfont mrdoc-icon-denglu"></i>
                登录
              </a>
            </dd>

          </dl>
          </a>
          {% endif %}

        </li>
      </ul>
    </div>

  </div>
</div>
<div class="jianghu-header-back"></div>
<div id="jianghu-munu">
  <div class="layui-panel site-menu">
    <ul class="layui-menu layui-menu-lg">
      <li class="layui-menu-item-group" lay-options="{type: 'group', isAllowSpread: true}">
        <ul>
          {% for category in categoryList %}
          <li class="<$ 'layui-menu-item-checked2' if category.active else '' $>">
            <div class="layui-menu-body-title">
              <a href="/<$ ctx.app.config.appId $>/page/article/<$ category.articleList[0].articleId $>">
                <span><$ category.categoryName $> </span>
              </a>
            </div>
          </li>
          {% endfor %}
        </ul>
      </li>
    </ul>
  </div>
</div>


{% include 'common/jianghuAxios.html' %}

<script type="text/javascript">


  const pageUrl = "<$ pageUrl $>";
  const adminUrl = "<$ adminUrl $>";
  const userId = "<$ userId $>";
  const username = "<$ username $>";
  async function logout() {
    $.removeCookie('<$ appId $>_authToken', { path: '/' });
    localStorage.removeItem('<$ appId $>_authToken');
    setTimeout(() => {
      location.reload();
    }, 360)
  }
  //注意：导航 依赖 element 模块，否则无法进行功能性操作
  layui.use('element', function(){
    const element = layui.element;
  });
  //修改用户密码
  changePwd = function(){
    layer.open({
      type:1,
      title:'修改密码',
      area:'300px;',
      id:'changePwd',
      content: `
                    <div style="padding:10px 0 0 20px;">
                        修改用户[${username}]的密码：
                    </div>
                    <div style="padding: 20px;">
                        <input class="layui-input" type="password" id="oldPwd" style="margin-bottom:10px;" placeholder="输入原密码" required lay-verify="required">
                        <input class="layui-input" type="password" id="newPwd1" style="margin-bottom:10px;" placeholder="输入新密码" required lay-verify="required">
                        <input class="layui-input" type="password" id="newPwd2" placeholder="再次确认新密码" required  lay-verify="required">
                    </div>`,
      btn:['确认修改','取消'],
      yes: async function (index,layero) {
        const oldPwd = $("#oldPwd").val();
        const newPwd1 = $("#newPwd1").val();
        const newPwd2 = $("#newPwd2").val();
        if (newPwd1 !== newPwd2) {
          layer.msg('两次输入的密码不一致', {icon: 2});
          return;
        }
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'allPage',
              actionId: 'resetPassword',
              actionData: {
                oldPassword: oldPwd,
                newPassword: newPwd1
              }
            }
          }
        })
        debugger
        layer.msg('密码修改成功', {icon: 1});
        layer.closeAll('page');
        location.reload();
      },
    })
  };

  layui.use(['dropdown', 'layer', 'table'], function() {
    var dropdown = layui.dropdown
      , layer = layui.layer

    //手机端用户操作
    dropdown.render({
      elem: '#userIcon'
      , data: !username ? [
        { title: '登录' }] : [
        { title: '进入后台' },
        { title: '修改密码' },
        { title: '退出登录' }
      ]
      , click: function (obj) {
        switch (obj.title) {
          case "进入后台":
            location.href = adminUrl
            break;
          case "修改密码":
            changePwd()
            break;
          case "退出登录":
            logout()
            break;
          case "登录":
            location.href = pageUrl + '/login'
            break;
        }
      }
    });
  });
</script>

{% block content %}{% endblock %}
<script>
  function showCategoryMenu() {
    // $('body').addClass('big-page');
    layer.open({
      type: 1,
      // r表示right,b表示bottom
      offset: 'rb',
      // 文集目录
      title: '菜单',
      //
      // anim 特效 0-平滑放大 1-从上掉落 2-从底部往上滑入 3-从左滑入 4-从左翻转 5-渐显 6-抖动
      anim: 5,
      shadeClose: true, //开启遮罩关闭
      // 第一个参数宽度，第二个参数高度
      area: ['300px', '100%'],
      // 内容区 在body中写入<div id="draw">。。。。</div>代码，即弹窗内容
      content: $("#jianghu-munu").html(),
    })
  }
</script>

</body>
