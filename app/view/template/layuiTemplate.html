{% set appId = ctx.app.config.appId %}
{% set userId = userInfo.userId %}
{% set username = userInfo.username %}
{% set adminUrl = ctx.app.config.adminUrl %}
{% set static = "/" + appId + "/public/" %}
{% set pageUrl = "/" + appId + "/page" %}
<!DOCTYPE html>
<html lang="zh-cn" style="font-size: 15px;">

<head>
    <meta charset="UTF-8">
    <meta name=renderer content=webkit>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge，chrome=1">
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta http-equiv="Cache-Control" content="max-age=7200" />
    <!-- <meta name="referrer" content="no-referrer"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="{% block keyword %}{% endblock %}<$ site_keywords $>" />
    <meta name="description" content="{% block description %}{% endblock %}" />
    <!-- OGP分享协议开始 -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="{% block ogp_title %}{% endblock %}">
    <meta property="og:description" content="{% block ogp_desc %}{% endblock %}">
    <meta property="og:image"
        content="<$ request.scheme $>://<$ request.META.HTTP_HOST $><$ static $>search/mrdoc_logo_300.png">
    <meta property="og:pageUrl" content="<$ request.scheme $>://<$ request.META.HTTP_HOST $><$ request.path_info $>">

    <script type="text/javascript">
        window.appInfo = {
            appId: '<$ ctx.app.config.appId $>',
            upload: '/<$ ctx.app.config.appId $>/upload',
            public: '/<$ ctx.app.config.appId $>/public',
            userAgent: navigator.userAgent || '',
        }
        if (window.appInfo.userAgent.length > 127) {
            window.appInfo.userAgent = window.appInfo.userAgent.substring(0, 126);
        }
    </script>

    <!-- OGP分享协议结束 -->
    <title>{% block title %}{% endblock %} - <$ ctx.app.config.appTitle $></title>
    <link href="<$ static $>layui/css/layui.css" rel="stylesheet">
    <link rel="stylesheet" href="<$ static $>editor.md/css/editormd.css" />
    <!-- <link rel="stylesheet" href="<$ static $>vditor/dist/index.css" /> -->
    <link href="<$ static $>viewerjs/viewer.min.css" rel="stylesheet">
    <link href="<$ static $>mrdoc/mrdoc.css" rel="stylesheet">
    <link href="<$ static $>mrdoc/mrdoc-docs.css" rel="stylesheet">
    <link href="<$ static $>iconFont/iconfont.css" rel="stylesheet">
    <script src="<$ static $>jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="<$ static $>layui/layui.js"></script>
    <script src="<$ static $>js/lib/lodash.min.js"></script>
    <script src="<$ static $>js/lib/axios.min.js"></script>
    <script type="text/javascript">
        window.vtoast = {
            success: (message) => {
                layer.msg(message, {icon: 1});
            },
            fail: (message) => {
                layer.msg(message, {icon: 2});
            },
            loading: (message) => {
                layer.msg(message, {icon: 0});
            }
        };
    </script>
</head>

<body class="big-page">

    <div class="layui-header">
        <div class="layui-fluid header-body" style="height: 100%; display: flex; justify-content: space-between;">
            <i class="layui-icon header-menu-icon layui-icon-slider layui-show-xs-inline" style="display: none" onclick="showCategory()"></i>
            <a class="logo" href="/">
                <img src="https://yun.startalk.tech/index.php/s/JxPejNyea9bn3gB/download" alt="layui">
            </a>
            <div class="layui-hide-xs site-notice"></div>

            <ul class="layui-nav layui-hide-xs" id="LAY_NAV_TOP" style="position: unset;">
                <li class="layui-nav-item <$ homeActive $>">
                    <a href="/">首&nbsp;&nbsp;页</a>
                </li>
                {% for category in categoryList %}
                <li class="layui-nav-item <$ category.active $>">
                    <a href="/<$ ctx.app.config.appId $>/page/article/<$ category.articleList[0].articleId $>/"><$ category.categoryName $></a>
                </li>
                {% endfor %}
                <li class="layui-nav-item">
                    {% if username %}
                    <a href="javascript:void(0);">
                        <i class="layui-icon layui-icon-friends"></i>
                        <span class="layui-hide-xs"> <$ username $> </span>
                    <i class="layui-icon layui-icon-down layui-nav-more"></i></a>
                    <dl class="layui-nav-child layui-anim layui-anim-upbit">

                        <dd>
                            <a href="<$ adminUrl $>" title="进入站点后台管理" target="_blank">
                                <i class="layui-icon layui-icon-console layui-hide-md"></i>
                                <span class="layui-hide-xs">进入后台</span>
                            </a>
                        </dd>
                        <dd>
                            <a href="javascript:void(0);" onclick="changePwd()" title="修改登录密码">
                                <i class="layui-icon layui-icon-password layui-hide-md"></i>
                                <span class="layui-hide-xs">修改密码</span>
                            </a>
                        </dd>
                        <dd>
                            <a href="javascript:void(0);" onclick="logout()" title="退出登录">
                                <i class="layui-icon layui-icon-logout layui-hide-md"></i>
                                <span class="layui-hide-xs">退出登录</span>
                            </a>
                        </dd>
                    </dl>
                    {% else %}
                    <a href="javascript:void(0);">
                        <i class="layui-icon layui-icon-username"></i> 游客
                        <i class="layui-icon layui-icon-down layui-nav-more"></i></a>
                        <dl class="layui-nav-child layui-anim layui-anim-upbit">
                            <dd>
                                <a href="<$ pageUrl $>/login">
                                    <i class="iconfont mrdoc-icon-denglu"></i>
                                    登录
                                </a>
                            </dd>

                        </dl>
                    </a>
                    {% endif %}

                </li>
            </ul>
        </div>
    </div>
    <div id="drawer">
        <div class="layui-panel site-menu">
            <ul class="layui-menu layui-menu-lg">
                <li class="layui-menu-item-group" lay-options="{type: 'group', isAllowSpread: true}">
                    <ul>
                        {% for category in categoryList %}
                        <li class="<$ 'layui-menu-item-checked2' if category.active else '' $>">
                            <div class="layui-menu-body-title">
                                <a href="/<$ ctx.app.config.appId $>/page/article/<$ category.articleList[0].articleId $>">
                                    <span><$ category.categoryName $> </span>
                                </a>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    {% include 'common/jianghuAxios.html' %}

    <script type="text/javascript">
        const userId = "<$ userId $>";
        const username = "<$ username $>";
        async function logout() {
            $.removeCookie('<$ appId $>_authToken', { path: '/' });
            localStorage.removeItem('<$ appId $>_authToken');
            setTimeout(() => {
                location.reload();
            }, 360)
        }
        //注意：导航 依赖 element 模块，否则无法进行功能性操作
        layui.use('element', function(){
            const element = layui.element;
        });
        //修改用户密码
        changePwd = function(){
            layer.open({
                type:1,
                title:'修改密码',
                area:'300px;',
                id:'changePwd',
                content: `
                    <div style="padding:10px 0 0 20px;">
                        修改用户[${username}]的密码：
                    </div>
                    <div style="padding: 20px;">
                        <input class="layui-input" type="password" id="oldPwd" style="margin-bottom:10px;" placeholder="输入原密码" required lay-verify="required">
                        <input class="layui-input" type="password" id="newPwd1" style="margin-bottom:10px;" placeholder="输入新密码" required lay-verify="required">
                        <input class="layui-input" type="password" id="newPwd2" placeholder="再次确认新密码" required  lay-verify="required">
                    </div>`,
                btn:['确认修改','取消'],
                yes: async function (index,layero) {
                    const oldPwd = $("#oldPwd").val();
                    const newPwd1 = $("#newPwd1").val();
                    const newPwd2 = $("#newPwd2").val();
                    if (newPwd1 !== newPwd2) {
                        layer.msg('两次输入的密码不一致', {icon: 2});
                        return;
                    }
                    await window.jianghuAxios({
                        data: {
                            appData: {
                                pageId: 'allPage',
                                actionId: 'resetPassword',
                                actionData: {
                                    oldPassword: oldPwd,
                                    newPassword: newPwd1
                                }
                            }
                        }
                    })
                    layer.msg('密码修改成功', {icon: 1});
                    layer.closeAll('page');
                    location.reload();
                },
            })
        };
    </script>

    {% block content %}{% endblock %}

</body>
